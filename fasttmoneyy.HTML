<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Fast Money – Fixed Reveal + Sounds + Reliable Per-row Animations</title>
<style>
  :root{--bg:#000;--accent:#72f090;--text:#eaffef;--dark:#001100;--panel:#071b11}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,sans-serif}
  .board{width:1280px;max-width:100%;margin:30px auto;padding:30px;background:linear-gradient(#083a1f,#0a6b3b);border-radius:16px;
         border:12px solid rgba(0,0,0,0.7);box-shadow:0 8px 40px rgba(0,0,0,0.7) inset;position:relative}
  .timer-wrap{position:absolute;top:10px;left:50%;transform:translateX(-50%);z-index:10}
  .fm-timer{width:160px;height:86px;background:linear-gradient(#0f7a3f,#0d5b2b);border-radius:50px;display:flex;flex-direction:column;align-items:center;justify-content:center;
            border:4px solid #000;box-shadow:0 6px 20px #000}
  .fm-timer .num{font-size:48px;font-weight:800;color:#dfffe6;line-height:1}
  .timer-small-label{font-size:10px;opacity:0.7;margin-top:-4px}
  .rows{margin-top:120px;display:flex;flex-direction:column;gap:12px}
  .row{display:flex;gap:16px;align-items:center}
  .slot{flex:1;height:56px;background:var(--dark);border-radius:10px;overflow:hidden;position:relative;
        border:3px solid rgba(0,0,0,0.6);box-shadow:inset 0 -4px 10px rgba(0,0,0,0.7)}
  .slot .text{position:absolute;inset:0;display:flex;align-items:center;padding-left:16px;font-size:21px;
              transform:translateX(-100%);transition:transform .45s cubic-bezier(.2,.9,.2,1)}
  .slot.revealed .text{transform:translateX(0)}
  .num{width:96px;height:56px;background:rgba(0,0,0,0.85);border-radius:10px;border:3px solid rgba(0,0,0,0.6);
       font-size:22px;display:flex;align-items:center;justify-content:center}

  /* Control Panel */
  .panel{max-width:1200px;margin:30px auto;background:var(--panel);padding:30px;border-radius:16px;
         border:1px solid rgba(255,255,255,0.05);box-shadow:0 10px 30px rgba(0,0,0,0.6)}
  h1{color:var(--accent);margin:0 0 25px;font-size:28px;text-align:center}
  .sound-row,.timer-row{display:flex;gap:12px;align-items:center;margin:15px 0;flex-wrap:wrap}
  .sound-row label,.timer-row label{color:var(--accent);min-width:160px;font-weight:600}
  button{padding:10px 16px;border-radius:8px;border:none;background:var(--accent);color:#000;font-weight:600;cursor:pointer}
  button:hover{background:#9fffbb}
  button.danger{background:#ff4444}
  button.danger:hover{background:#ff6666}
  .grid{display:grid;grid-template-columns:1fr 110px 110px 110px;gap:12px;align-items:center;margin:30px 0}
  input[type=text],input[type=number]{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:white}
  .bigbtn{padding:16px 32px;font-size:20px;margin:8px}
  .footer{margin-top:30px;text-align:center;opacity:0.7;font-size:14px}
  .small{padding:6px 10px;font-size:13px}
</style>
</head>
<body>
<div id="app"></div>

<script>
/* ----- config ----- */
const params = new URLSearchParams(location.search);
const mode = params.get('mode') || 'overlay';
const ROWS = 10;

/* ----- audio keys ----- */
const KEY_TEXT = 'fm_sound_text';
const KEY_NUMBER = 'fm_sound_number';
const KEY_TIMER = 'fm_sound_timer';

/* ----- audio URLs in memory ----- */
let soundTextUrl = null;
let soundNumberUrl = null;
let soundTimerStartUrl = null;

/* ----- state ----- */
let state = {
  rows: Array.from({length: ROWS}, (_, i) => ({
    text: `Answer ${i+1}`,
    score: (ROWS - i) * 10,
    revealedText: false,
    revealedScore: false
  })),
  timer: { seconds: 30, remaining: 30, running: false }
};

/* Load saved state */
try {
  const saved = localStorage.getItem('fmstate');
  if (saved) state = JSON.parse(saved);
} catch (err) {}

/* Save state */
function save() { localStorage.setItem('fmstate', JSON.stringify(state)); }

/* Play helper */
function play(src) {
  if (!src) return;
  try {
    const a = new Audio(src);
    a.currentTime = 0;
    a.play().catch(()=>{});
  } catch {}
}

/* Broadcast channel */
const bc = new BroadcastChannel('fastmoney2025');

bc.onmessage = (e) => {
  const d = e.data || {};

  if (d.type === "audioSync") {
    soundTextUrl = d.text;
    soundNumberUrl = d.num;
    soundTimerStartUrl = d.timer;
    return;
  }

  if (d.type === 'update') {
    state = d.state;
    save();
    render();
    return;
  }

  if (d.type === 'revealText') {
    const idx = Number(d.i);
    if (state.rows[idx]) state.rows[idx].revealedText = true;
    save();
    play(soundTextUrl);
    render();
    return;
  }

  if (d.type === 'revealScore') {
    const idx = Number(d.i);
    if (state.rows[idx]) state.rows[idx].revealedScore = true;
    save();
    play(soundNumberUrl);
    render();
    return;
  }

  if (d.type === 'timer') {
    state.timer = d.timer;
    save();
    render();
    return;
  }
};

/* Send message */
function send(msg) { bc.postMessage(msg); }

/* RENDER OVERLAY */
function renderOverlay() {
  clearInterval(window.timerInterval);

  document.getElementById('app').innerHTML = `
    <div class="board">
      <div class="timer-wrap">
        <div class="fm-timer">
          <div class="num">${state.timer.remaining}</div>
          <div class="timer-small-label">FAST MONEY</div>
        </div>
      </div>

      <div class="rows">
        ${state.rows.map(r => `
          <div class="row">
            <div class="slot ${r.revealedText ? 'revealed' : ''}">
              <div class="text">${escapeHtml(r.text)}</div>
            </div>
            <div class="num">${r.revealedScore ? r.score : ''}</div>
          </div>
        `).join('')}
      </div>
    </div>
  `;

  if (state.timer.running) {
    window.timerInterval = setInterval(() => {
      if (state.timer.remaining > 0) {
        state.timer.remaining--;
      } else {
        state.timer.running = false;
        clearInterval(window.timerInterval);
      }
      save();
      send({ type: 'timer', timer: state.timer });
      document.querySelector('.fm-timer .num').textContent = state.timer.remaining;
    }, 1000);
  }
}

/* RENDER CONTROL PANEL */
function renderControl() {
  document.getElementById('app').innerHTML = `
    <div class="panel">
      <h1>Fast Money Control Panel</h1>

      <div class="sound-row">
        <label>Text Reveal Sound</label>
        <input type="file" id="upText" accept="audio/*">
        <button class="small" id="previewTextBtn">Preview</button>
        <span>${soundTextUrl ? 'Loaded' : 'No sound'}</span>
      </div>

      <div class="sound-row">
        <label>Number Reveal Sound</label>
        <input type="file" id="upNum" accept="audio/*">
        <button class="small" id="previewNumBtn">Preview</button>
        <span>${soundNumberUrl ? 'Loaded' : 'No sound'}</span>
      </div>

      <div class="sound-row">
        <label>Timer Start Sound</label>
        <input type="file" id="upTimer" accept="audio/*">
        <button class="small" id="previewTimerBtn">Preview</button>
        <span>${soundTimerStartUrl ? 'Loaded' : 'No sound'}</span>
      </div>

      <div class="timer-row">
        <label>Timer Control</label>
        <button id="startBtn" class="bigbtn">${state.timer.running ? 'Running...' : 'Start 30s Timer'}</button>
        <button id="stopBtn" class="bigbtn danger" ${state.timer.running ? '' : 'disabled'}>Stop</button>
        <button id="resetBtn" class="bigbtn">Reset</button>
        <span style="margin-left:20px;font-size:18px">Time left: <strong id="timeLeft">${state.timer.remaining}s</strong></span>
      </div>

      <div class="grid">
        ${state.rows.map((r, i) => `
          <input type="text" value="${escapeHtml(r.text)}" data-i="${i}" class="text-input" placeholder="Answer">
          <input type="number" value="${r.score}" data-i="${i}" min="0" class="num-input">
          <button class="small show-text-btn" data-i="${i}">Show Text</button>
          <button class="small show-num-btn" data-i="${i}">Show #</button>
        `).join('')}
      </div>

      <div style="text-align:center;margin-top:30px">
        <button class="bigbtn" id="updateBtn">UPDATE OVERLAY</button>
        <button class="bigbtn" id="resetAllBtn" style="background:#ff5555">RESET EVERYTHING</button>
      </div>

      <div class="footer">
        Normal URL → OBS overlay<br>?mode=control → this panel
      </div>
    </div>
  `;

  /* Input handlers */
  document.querySelectorAll('.text-input').forEach(inp =>
    inp.addEventListener('input', e => {
      const i = Number(e.target.dataset.i);
      state.rows[i].text = e.target.value;
    })
  );

  document.querySelectorAll('.num-input').forEach(inp =>
    inp.addEventListener('input', e => {
      const i = Number(e.target.dataset.i);
      state.rows[i].score = Number(e.target.value) || 0;
    })
  );

  document.querySelectorAll('.show-text-btn').forEach(btn =>
    btn.addEventListener('click', e => {
      const i = Number(e.target.dataset.i);
      send({ type: 'revealText', i });
    })
  );

  document.querySelectorAll('.show-num-btn').forEach(btn =>
    btn.addEventListener('click', e => {
      const i = Number(e.target.dataset.i);
      send({ type: 'revealScore', i });
    })
  );

  /* Timer control */
  document.getElementById('startBtn').addEventListener('click', () => {
    state.timer.remaining = 30;
    state.timer.running = true;
    save();
    play(soundTimerStartUrl);
    send({ type: 'timer', timer: state.timer });
    render();
  });

  document.getElementById('stopBtn').addEventListener('click', () => {
    state.timer.running = false;
    save();
    send({ type: 'timer', timer: state.timer });
    render();
  });

  document.getElementById('resetBtn').addEventListener('click', () => {
    state.timer.remaining = 30;
    state.timer.running = false;
    save();
    send({ type: 'timer', timer: state.timer });
    render();
  });

  /* Save updates */
  document.getElementById('updateBtn').addEventListener('click', () => {
    save();
    send({ type: 'update', state });
  });

  document.getElementById('resetAllBtn').addEventListener('click', () => {
    state.rows.forEach(r => { r.revealedText = false; r.revealedScore = false; });
    state.timer.remaining = 30;
    state.timer.running = false;
    save();
    send({ type: 'update', state });
    render();
  });

  /* Load audio files */
  document.getElementById('upText').addEventListener('change', e => {
    if (e.target.files[0]) loadSoundFile(e.target.files[0], KEY_TEXT);
  });

  document.getElementById('upNum').addEventListener('change', e => {
    if (e.target.files[0]) loadSoundFile(e.target.files[0], KEY_NUMBER);
  });

  document.getElementById('upTimer').addEventListener('change', e => {
    if (e.target.files[0]) loadSoundFile(e.target.files[0], KEY_TIMER);
  });

  /* Preview */
  document.getElementById('previewTextBtn').addEventListener('click', () => play(soundTextUrl));
  document.getElementById('previewNumBtn').addEventListener('click', () => play(soundNumberUrl));
  document.getElementById('previewTimerBtn').addEventListener('click', () => play(soundTimerStartUrl));
}

/* Load sound into storage */
function loadSoundFile(file, storageKey) {
  const r = new FileReader();
  r.onload = ev => {
    const data = ev.target.result;
    localStorage.setItem(storageKey, data);

    if (storageKey === KEY_TEXT) soundTextUrl = data;
    if (storageKey === KEY_NUMBER) soundNumberUrl = data;
    if (storageKey === KEY_TIMER) soundTimerStartUrl = data;

    /* sync audio to overlay */
    send({
      type: "audioSync",
      text: soundTextUrl,
      num: soundNumberUrl,
      timer: soundTimerStartUrl
    });

    if (mode === 'control') renderControl();
  };
  r.readAsDataURL(file);
}

/* Escape HTML */
function escapeHtml(str) {
  if (str == null) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

/* Init: load stored audio + sync */
(function initAudioFromStorage() {
  soundTextUrl = localStorage.getItem(KEY_TEXT);
  soundNumberUrl = localStorage.getItem(KEY_NUMBER);
  soundTimerStartUrl = localStorage.getItem(KEY_TIMER);

  send({
    type: "audioSync",
    text: soundTextUrl,
    num: soundNumberUrl,
    timer: soundTimerStartUrl
  });
})();

/* Autoplay fix: allow overlay to unlock audio */
if (mode === 'overlay') {
  window.addEventListener(
    'click',
    () => {
      if (soundTextUrl) new Audio(soundTextUrl).play().catch(()=>{});
      if (soundNumberUrl) new Audio(soundNumberUrl).play().catch(()=>{});
      if (soundTimerStartUrl) new Audio(soundTimerStartUrl).play().catch(()=>{});
    },
    { once: true }
  );
}

/* Initial render */
function render() {
  if (mode === 'control') renderControl();
  else renderOverlay();
}

render();
</script>
</body>
</html>
